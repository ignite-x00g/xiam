// =============== PGP PUBLIC KEY FOR HOMEPAGE FORMS ===============
const PGP_PUBLIC_KEY = `-----BEGIN PGP PUBLIC KEY BLOCK-----
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
YWNemsLcY+oWFw==
=Xcq4
-----END PGP PUBLIC KEY BLOCK-----`;

let joinFormRecaptchaWidgetId = null;
let contactFormRecaptchaWidgetId = null;

document.addEventListener("DOMContentLoaded", () => {

  // ================================================================
  // LANGUAGE TOGGLE (Desktop & Mobile)
  // =================================================================

  let currentLanguage = localStorage.getItem("language") || "en";
  const langToggleDesktop = document.getElementById("language-toggle-desktop");
  const langToggleMobile  = document.getElementById("language-toggle-mobile");

  function updateLanguage(lang) {
    const translatableElements = document.querySelectorAll("[data-en]");
    translatableElements.forEach((el) => {
      el.textContent = (lang === "en")
        ? el.getAttribute("data-en")
        : el.getAttribute("data-es");
    });

    const placeholderElements = document.querySelectorAll("[data-en-placeholder]");
    placeholderElements.forEach((el) => {
      el.placeholder = (lang === "en")
        ? el.getAttribute("data-en-placeholder")
        : el.getAttribute("data-es-placeholder");
    });

    const textElements = document.querySelectorAll("[data-en-text]");
    textElements.forEach((el) => {
      el.textContent = (lang === "en")
        ? el.getAttribute("data-en-text")
        : el.getAttribute("data-es-text");
    });
  }

  // ================================================================
  // Collapsible Checkbox Group Logic (for "Would like to work")
  // =================================================================
  const workPreferenceTrigger = document.querySelector('#join-modal .collapsible-trigger');
  const workPreferencePanel = document.querySelector('#join-modal .collapsible-panel');
  const workPreferenceDoneBtn = document.querySelector('#join-modal .collapsible-done-btn');

  if (workPreferenceTrigger && workPreferencePanel) {
    workPreferenceTrigger.addEventListener('click', function() {
      const isExpanded = this.getAttribute('aria-expanded') === 'true';
      this.setAttribute('aria-expanded', !isExpanded);
      workPreferencePanel.classList.toggle('active'); // Assumes CSS handles .active display
    });
  }

  if (workPreferenceDoneBtn && workPreferencePanel) {
    workPreferenceDoneBtn.addEventListener('click', function() {
      if (workPreferenceTrigger) {
          workPreferenceTrigger.setAttribute('aria-expanded', 'false');
      }
      workPreferencePanel.classList.remove('active');
      // Optional: Update trigger text with summary of selections
      // const selectedCount = workPreferencePanel.querySelectorAll('input[type="checkbox"]:checked').length;
      // if (selectedCount > 0 && workPreferenceTrigger) {
      //    // Ensure currentLanguage is accessible or fetched here for proper translation
      //    const optionText = currentLanguage === 'es' ? 'opciones seleccionadas' : 'options selected';
      //    const optionSingular = currentLanguage === 'es' ? 'opción seleccionada' : 'option selected';
      //    workPreferenceTrigger.textContent = selectedCount + ' ' + (selectedCount === 1 ? optionSingular : optionText);
      // } else if (workPreferenceTrigger) {
      //    // Reset to default text, considering language
      //    workPreferenceTrigger.textContent = currentLanguage === 'es' ? workPreferenceTrigger.dataset.es : workPreferenceTrigger.dataset.en;
      // }
    });
  }

  // ================================================================
  // Dynamic Field Addition/Removal for Join Us Form
  // =================================================================
  document.querySelectorAll('.add-field-btn').forEach(button => {
    button.addEventListener('click', function() {
      const targetContainerId = this.dataset.target;
      const maxFields = parseInt(this.dataset.max);
      const container = document.getElementById(targetContainerId);
      const addButton = this; // Reference to the add button itself

      if (container.children.length < maxFields) {
        const fieldItem = document.createElement('div');
        fieldItem.classList.add('dynamic-field-item');

        let fieldHTML = '';
        const baseName = targetContainerId.replace('-fields-container', '');

        if (['experience', 'skills', 'hobbies'].includes(baseName)) {
          fieldHTML = `<input type="text" name="${baseName}[]" class="dynamic-input" data-en-placeholder="Enter detail" data-es-placeholder="Ingrese detalle" placeholder="Enter detail" style="flex-grow: 1; margin-right: 5px;">`;
        } else if (['workroles', 'education', 'certifications', 'continued-education'].includes(baseName)) {
          fieldHTML =
            `<input type="text" name="${baseName}_description[]" class="dynamic-input" data-en-placeholder="Description" data-es-placeholder="Descripción" placeholder="Description" style="flex-grow: 1; margin-right: 5px;">` +
            `<input type="date" name="${baseName}_date[]" class="dynamic-date" style="margin-right: 5px;">`;
        }

        // Add the remove button HTML
        fieldHTML += '<button type="button" class="remove-field-btn" data-en-text="-" data-es-text="-">-</button>';
        fieldItem.innerHTML = fieldHTML;
        container.appendChild(fieldItem);

        // Ensure new elements are translated immediately
        if (typeof updateLanguage === "function" && typeof currentLanguage !== "undefined") {
          updateLanguage(currentLanguage);
        }
      } else {
        alert('Maximum ' + maxFields + ' fields allowed.');
      }

      // Disable add button if max fields reached
      if (container.children.length >= maxFields) {
        addButton.disabled = true;
        addButton.style.opacity = '0.5'; // Visually indicate disabled state
      }
    });
  });

  // Event delegation for remove buttons within the 'join-modal'
  const joinModal = document.getElementById('join-modal');
  if (joinModal) {
    joinModal.addEventListener('click', function(event) {
      if (event.target && event.target.classList.contains('remove-field-btn')) {
        const fieldItemToRemove = event.target.closest('.dynamic-field-item');
        const container = fieldItemToRemove.parentElement;
        const addButton = container.nextElementSibling; // Assuming add button is the next sibling of the container

        fieldItemToRemove.remove();

        // Re-enable the corresponding add button if it was disabled
        if (addButton && addButton.classList.contains('add-field-btn')) {
          const maxFields = parseInt(addButton.dataset.max);
          if (container.children.length < maxFields) {
            addButton.disabled = false;
            addButton.style.opacity = '1';
          }
        }
      }
    });
  }

  // Initialize language on load
  document.body.setAttribute("lang", currentLanguage);
  updateLanguage(currentLanguage);

  // Set initial button labels
  function setLanguageButtonLabels() {
    if (langToggleDesktop) {
      langToggleDesktop.textContent = (currentLanguage === "en") ? "ES" : "EN";
    }
    if (langToggleMobile) {
      const mobileSpan = langToggleMobile.querySelector("span") || langToggleMobile;
      mobileSpan.textContent = (currentLanguage === "en") ? "ES" : "EN";
    }
  }
  setLanguageButtonLabels();

  function toggleLanguage() {
    currentLanguage = (currentLanguage === "en") ? "es" : "en";
    localStorage.setItem("language", currentLanguage);
    document.body.setAttribute("lang", currentLanguage);
    updateLanguage(currentLanguage);
    setLanguageButtonLabels();
  }

  if (langToggleDesktop) {
    langToggleDesktop.addEventListener("click", toggleLanguage);
  }
  if (langToggleMobile) {
    langToggleMobile.addEventListener("click", toggleLanguage);
  }

  // ================================================================
  // THEME TOGGLE (Desktop & Mobile)
  // =================================================================
  const themeToggleDesktop = document.getElementById("theme-toggle-desktop");
  const themeToggleMobile  = document.getElementById("theme-toggle-mobile");
  const bodyElement = document.body;
  const savedTheme = localStorage.getItem("theme") || "light";
  bodyElement.setAttribute("data-theme", savedTheme);

  function setupThemeToggle(button) {
    if (!button) return;
    button.textContent = (savedTheme === "light") ? "Dark" : "Light";
    button.addEventListener("click", () => {
      const currentTheme = bodyElement.getAttribute("data-theme");
      if (currentTheme === "light") {
        bodyElement.setAttribute("data-theme", "dark");
        button.textContent = "Light";
        localStorage.setItem("theme", "dark");
      } else {
        bodyElement.setAttribute("data-theme", "light");
        button.textContent = "Dark";
        localStorage.setItem("theme", "light");
      }
    });
  }
  setupThemeToggle(themeToggleDesktop);
  setupThemeToggle(themeToggleMobile);

  // ================================================================
  // Modal, Menu, etc. UI Logic (Existing code from here)
  // =================================================================
  const menuOpenBtn = document.getElementById('menu-open');
  const menuCloseBtn = document.getElementById('menu-close');
  const rightSideMenu = document.getElementById('rightSideMenu');

  if (menuOpenBtn && menuCloseBtn && rightSideMenu) {
    menuOpenBtn.addEventListener('click', () => {
      rightSideMenu.classList.add('open');
    });
    menuCloseBtn.addEventListener('click', () => {
      rightSideMenu.classList.remove('open');
    });
  }

  const servicesTrigger = document.querySelector('.services-trigger button');
  const servicesSubMenu = document.getElementById('servicesSubMenu');

  if (servicesTrigger && servicesSubMenu) {
    servicesTrigger.addEventListener('click', (e) => {
      e.stopPropagation();
      servicesSubMenu.classList.toggle('open');
    });
    document.addEventListener('click', (evt) => {
      if (!servicesTrigger.contains(evt.target) && !servicesSubMenu.contains(evt.target)) {
        servicesSubMenu.classList.remove('open');
      }
    });
  }

  // ================================================================
  // ReCAPTCHA Rendering
  // =================================================================
  function joinRecaptchaSuccess(token) { /* Placeholder for success action */ }
  function joinRecaptchaExpired() { /* Placeholder for expired action */ }
  function contactRecaptchaSuccess(token) { /* Placeholder for success action */ }
  function contactRecaptchaExpired() { /* Placeholder for expired action */ }

  function renderRecaptchaWidgets() {
    if (typeof grecaptcha !== 'undefined' && typeof grecaptcha.render !== 'undefined') {
      if (document.getElementById('recaptcha-join-form-container') && joinFormRecaptchaWidgetId === null) {
        joinFormRecaptchaWidgetId = grecaptcha.render('recaptcha-join-form-container', {
          'sitekey' : '6LfFOV0rAAAAAP2NYL8f1hPyfpsc-MiPx9n02THp', /* Join Us Form Key */
          'callback': joinRecaptchaSuccess,
          'expired-callback': joinRecaptchaExpired
        });
      }
      if (document.getElementById('recaptcha-contact-form-container') && contactFormRecaptchaWidgetId === null) {
        contactFormRecaptchaWidgetId = grecaptcha.render('recaptcha-contact-form-container', {
          'sitekey' : '6LfAOV0rAAAAAPBGgn2swZWj5SjANoQ4rUH6XIMz', /* Contact Us Form Key */
          'callback': contactRecaptchaSuccess,
          'expired-callback': contactRecaptchaExpired
        });
      }
    } else {
      // grecaptcha not ready, might retry or log minimally if needed for debugging
    }
  }

  // Attempt to render ReCAPTCHA widgets on DOMContentLoaded (if grecaptcha is already loaded)
  // More robust rendering happens when modals are opened.
  renderRecaptchaWidgets();

  // ================================================================
  // Modals (Join Us & Contact Us) - Updated to render ReCAPTCHA on open
  // =================================================================
  const modalOverlays = document.querySelectorAll('.modal-overlay');
  const closeModalButtons = document.querySelectorAll('[data-close]');
  const floatingIcons = document.querySelectorAll('.floating-icon');

  floatingIcons.forEach(icon => {
    icon.addEventListener('click', () => {
      const modalId = icon.getAttribute('data-modal');
      const targetModal = document.getElementById(modalId);
      if (targetModal) {
        targetModal.classList.add('active');
        // Attempt to render ReCAPTCHA for the opened modal if not already done
        if (modalId === 'join-modal' && joinFormRecaptchaWidgetId === null) {
          renderRecaptchaWidgets();
        } else if (modalId === 'contact-modal' && contactFormRecaptchaWidgetId === null) {
          renderRecaptchaWidgets();
        }
      }
    });
  });

  closeModalButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const parentModal = btn.closest('.modal-overlay');
      if (parentModal) parentModal.classList.remove('active');
    });
  });

  modalOverlays.forEach(overlay => {
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) overlay.classList.remove('active');
    });
    overlay.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') overlay.classList.remove('active');
    });
  });

  // =======================================================================================
  // PGP Encryption Function
  // =======================================================================================
  async function encryptFormData(formDataObject) {
    try {
      const publicKey = await openpgp.readKey({ armoredKey: PGP_PUBLIC_KEY });
      const message = await openpgp.createMessage({ text: JSON.stringify(formDataObject) });
      const encryptedData = await openpgp.encrypt({
        message,
        encryptionKeys: publicKey,
      });
      return encryptedData;
    } catch (error) {
      console.error('PGP Encryption failed:', error);
      throw error;
    }
  }
  
  // =======================================================================================
  // Form Submission Handlers (Join Us & Contact Us) - Updated
  // =======================================================================================
  function sanitizeInput(input) {
    return input.replace(/<[^>]*>/g, '').trim();
  }

  const joinForm = document.getElementById('join-form');
  if (joinForm) {
    joinForm.addEventListener('submit', async (e) => { // Made async
      e.preventDefault();
      const form = e.target;

      const recaptchaResponse = (joinFormRecaptchaWidgetId !== null) ? grecaptcha.getResponse(joinFormRecaptchaWidgetId) : '';
      if (recaptchaResponse.length === 0 && joinFormRecaptchaWidgetId !== null) { // Only validate if widget rendered
        alert('Please complete the ReCAPTCHA.');
        return;
      }

      // Basic Info
      const name = sanitizeInput(document.getElementById("join-name").value);
      const email = sanitizeInput(document.getElementById("join-email").value);
      const contact = sanitizeInput(document.getElementById("join-contact").value);

      // Dynamic Fields
      const experienceFields = [];
      document.querySelectorAll('#experience-fields-container .dynamic-input').forEach(input => experienceFields.push(sanitizeInput(input.value)));

      const skillsFields = [];
      document.querySelectorAll('#skills-fields-container .dynamic-input').forEach(input => skillsFields.push(sanitizeInput(input.value)));

      const hobbiesFields = [];
      document.querySelectorAll('#hobbies-fields-container .dynamic-input').forEach(input => hobbiesFields.push(sanitizeInput(input.value)));

      const workRoles = [];
      document.querySelectorAll('#workroles-fields-container .dynamic-field-item').forEach(item => {
        const description = item.querySelector('.dynamic-input[name^="workroles_description"]').value;
        const date = item.querySelector('.dynamic-date[name^="workroles_date"]').value;
        if (description || date) {
          workRoles.push({ description: sanitizeInput(description), date: date });
        }
      });

      const educationItems = [];
      document.querySelectorAll('#education-fields-container .dynamic-field-item').forEach(item => {
        const description = item.querySelector('.dynamic-input[name^="education_description"]').value;
        const date = item.querySelector('.dynamic-date[name^="education_date"]').value;
        if (description || date) {
          educationItems.push({ description: sanitizeInput(description), date: date });
        }
      });

      const certificationItems = [];
      document.querySelectorAll('#certifications-fields-container .dynamic-field-item').forEach(item => {
        const description = item.querySelector('.dynamic-input[name^="certifications_description"]').value;
        const date = item.querySelector('.dynamic-date[name^="certifications_date"]').value;
        if (description || date) {
          certificationItems.push({ description: sanitizeInput(description), date: date });
        }
      });

      const continuedEducationItems = [];
      document.querySelectorAll('#continued-education-fields-container .dynamic-field-item').forEach(item => {
        const description = item.querySelector('.dynamic-input[name^="continued-education_description"]').value;
        const date = item.querySelector('.dynamic-date[name^="continued-education_date"]').value;
        if (description || date) {
          continuedEducationItems.push({ description: sanitizeInput(description), date: date });
        }
      });

      // Multi-select (now checkboxes)
      const workPreference = [];
      document.querySelectorAll('#join-modal .collapsible-panel .checkbox-option input[type="checkbox"]:checked').forEach(checkbox => {
        workPreference.push(checkbox.value);
      });

      // File Names
      const resumeFile = document.getElementById('join-resume').files[0];
      const coverFile = document.getElementById('join-cover').files[0];
      const resumeFileName = resumeFile ? resumeFile.name : '';
      const coverFileName = coverFile ? coverFile.name : '';

      // Large Text Areas
      const coverLetterText = sanitizeInput(document.getElementById('cover-letter-text').value);
      const aboutYourselfText = sanitizeInput(document.getElementById('about-yourself-text').value);
      const reasonToHireText = sanitizeInput(document.getElementById('reason-to-hire-text').value);

      const timestamp = new Date().toISOString();
      const nonce = Array.from(window.crypto.getRandomValues(new Uint32Array(8))).map(n => n.toString(16)).join('');

      const dataToEncrypt = {
        name, email, contact,
        experience: experienceFields,
        skills: skillsFields,
        hobbies: hobbiesFields,
        workRoles,
        education: educationItems,
        certifications: certificationItems,
        continuedEducation: continuedEducationItems,
        workPreference,
        resumeFileName,
        coverFileName,
        coverLetter: coverLetterText,
        aboutYourself: aboutYourselfText,
        reasonToHire: reasonToHireText,
        timestamp,
        nonce
      };

      try {
        const encryptedPayload = await encryptFormData(dataToEncrypt);
        const submissionPayload = {
          encryptedData: encryptedPayload,
          recaptchaToken: recaptchaResponse
        };

        // alert('Form data would be PGP encrypted and sent.'); // Placeholder Commented Out

        // Actual fetch to Cloudflare worker
        const response = await fetch('https://join.gabrieloor-cv1.workers.dev/', { // Note: Ensure trailing slash if needed by worker
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(submissionPayload)
        });
        if (!response.ok) throw new Error('Server error: ' + response.statusText);
        const result = await response.text();
        alert('Form submitted successfully! Message: ' + result);

      } catch (error) {
        alert('Error submitting form. Please try again. ' + error.message);
      } finally {
        form.reset();
        if (joinFormRecaptchaWidgetId !== null) grecaptcha.reset(joinFormRecaptchaWidgetId);
        const parentModal = form.closest('.modal-overlay');
        if (parentModal) parentModal.classList.remove('active');
      }
    });
  }

  const contactForm = document.getElementById('contact-form');
  if (contactForm) {
    contactForm.addEventListener('submit', async (e) => { // Made async
      e.preventDefault();
      const form = e.target;

      const recaptchaResponse = (contactFormRecaptchaWidgetId !== null) ? grecaptcha.getResponse(contactFormRecaptchaWidgetId) : '';
      if (recaptchaResponse.length === 0 && contactFormRecaptchaWidgetId !== null) { // Only validate if widget rendered
        alert('Please complete the ReCAPTCHA.');
        return;
      }

      const name = sanitizeInput(document.getElementById("contact-name").value);
      const email = sanitizeInput(document.getElementById("contact-email").value);
      const number = sanitizeInput(document.getElementById("contact-number").value);
      const date = document.getElementById("contact-date").value;
      const time = document.getElementById("contact-time").value;
      const comments = sanitizeInput(document.getElementById("contact-comments").value);

      const timestamp = new Date().toISOString();
      const nonce = Array.from(window.crypto.getRandomValues(new Uint32Array(8))).map(n => n.toString(16)).join('');

      const dataToEncrypt = { name, email, number, date, time, comments, timestamp, nonce };

      try {
        const encryptedPayload = await encryptFormData(dataToEncrypt);
        const submissionPayload = {
          encryptedData: encryptedPayload,
          recaptchaToken: recaptchaResponse
        };

        // alert('Form data would be PGP encrypted and sent.'); // Placeholder Commented Out

        // Actual fetch to Cloudflare worker
        const response = await fetch('https://tiny-resonance-110a.gabrieloor-cv1.workers.dev/', { // Note: Ensure trailing slash if needed by worker
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(submissionPayload)
        });
        if (!response.ok) throw new Error('Server error: ' + response.statusText);
        const result = await response.text();
        alert('Form submitted successfully! Message: ' + result);

      } catch (error) {
        alert('Error submitting form. Please try again. ' + error.message);
      } finally {
        form.reset();
        if (contactFormRecaptchaWidgetId !== null) grecaptcha.reset(contactFormRecaptchaWidgetId);
        const parentModal = form.closest('.modal-overlay');
        if (parentModal) parentModal.classList.remove('active');
      }
    });
  }

  // ================================================================
  // Service Worker Registration
  // =================================================================
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/js/service-worker.js')
        .then(registration => {
          // Registration was successful, no console log needed here for production
        })
        .catch(error => {
          console.log('Service Worker registration failed: ', error);
        });
    });
  }
});
